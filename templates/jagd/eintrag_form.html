{% extends 'base.html' %}
{% load l10n %}

{% block title %}{% if eintrag %}Eintrag bearbeiten{% else %}Neuer Eintrag{% endif %} - Jagdtagebuch{% endblock %}

{% block extra_css %}
<style>
    .form-header {
        background: linear-gradient(135deg, #2d5016 0%, #4a7c23 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        padding: 1.5rem;
    }
    .form-card {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .wildart-group {
        margin-bottom: 1rem;
    }
    .wildart-group-title {
        font-weight: 600;
        color: #4a7c23;
        margin-bottom: 0.5rem;
        padding-bottom: 0.3rem;
        border-bottom: 2px solid #e9ecef;
    }
    .wildart-option {
        display: inline-block;
        margin: 0.2rem;
    }
    .wildart-option input[type="radio"] {
        display: none;
    }
    .wildart-option label {
        display: inline-block;
        padding: 0.5rem 1rem;
        border: 2px solid #dee2e6;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }
    .wildart-option input[type="radio"]:checked + label {
        border-color: #4a7c23;
        background: linear-gradient(135deg, #4a7c23 0%, #6b8e23 100%);
        color: white;
    }
    .wildart-option label:hover {
        border-color: #6b8e23;
        background: #f8f9fa;
    }
    .wildart-option input[type="radio"]:checked + label:hover {
        background: linear-gradient(135deg, #3d6812 0%, #5a7d12 100%);
    }
    .geschlecht-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-size: 1.1rem;
    }
    .geschlecht-btn.active {
        box-shadow: 0 0 0 3px rgba(74, 124, 35, 0.3);
    }
    .section-title {
        color: #4a7c23;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    .input-icon {
        position: relative;
    }
    .input-icon i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    .input-icon input,
    .input-icon select {
        padding-left: 2.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="form-card">
                <div class="form-header">
                    <h4 class="mb-0">
                        <i class="bi bi-{% if eintrag %}pencil{% else %}plus-lg{% endif %} me-2"></i>
                        {% if eintrag %}Eintrag bearbeiten{% else %}Waidmannsheil! Neuer Eintrag{% endif %}
                    </h4>
                </div>
                
                <form method="post" class="card-body p-4">
                    {% csrf_token %}
                    
                    <!-- Wildart -->
                    <h5 class="section-title"><i class="bi bi-crosshair me-2"></i>Wildart</h5>
                    <div class="mb-4">
                        {% for group, choices in WILDART_CHOICES %}
                        <div class="wildart-group">
                            <div class="wildart-group-title">{{ group }}</div>
                            {% for value, label in choices %}
                            <div class="wildart-option">
                                <input type="radio" name="wildart" id="wildart_{{ value }}" value="{{ value }}"
                                       {% if eintrag and eintrag.wildart == value %}checked{% elif not eintrag and value == 'rehbock' %}checked{% endif %}
                                       {% if value == 'sonstiges' %}onchange="toggleCustomWildart(this)"{% endif %}>
                                <label for="wildart_{{ value }}">{{ label }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                        
                        <div id="customWildartDiv" class="mt-3" style="display: {% if eintrag and eintrag.wildart == 'sonstiges' %}block{% else %}none{% endif %};">
                            <input type="text" name="wildart_custom" class="form-control" 
                                   placeholder="Eigene Wildart eingeben..."
                                   value="{{ eintrag.wildart_custom|default:'' }}">
                        </div>
                    </div>

                    <div class="row">
                        <!-- Datum & Zeit -->
                        <div class="col-md-6">
                            <h5 class="section-title"><i class="bi bi-calendar3 me-2"></i>Datum & Zeit</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-7">
                                    <label class="form-label">Datum *</label>
                                    <input type="date" name="datum" class="form-control" required
                                           min="2020-01-01" max="2099-12-31"
                                           value="{{ eintrag.datum|date:'Y-m-d'|default:heute }}">
                                </div>
                                <div class="col-5">
                                    <label class="form-label">Uhrzeit</label>
                                    <input type="time" name="uhrzeit" class="form-control"
                                           value="{{ eintrag.uhrzeit|time:'H:i'|default:'' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Geschlecht -->
                        <div class="col-md-6">
                            <h5 class="section-title"><i class="bi bi-gender-ambiguous me-2"></i>Geschlecht</h5>
                            <div class="btn-group w-100 mb-4" role="group">
                                {% for value, label in GESCHLECHT_CHOICES %}
                                <input type="radio" class="btn-check" name="geschlecht" id="geschlecht_{{ value }}" 
                                       value="{{ value }}" {% if eintrag and eintrag.geschlecht == value %}checked{% elif not eintrag and value == 'u' %}checked{% endif %}>
                                <label class="btn btn-outline-secondary geschlecht-btn" for="geschlecht_{{ value }}">{{ label }}</label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Ort & Revier -->
                    <h5 class="section-title"><i class="bi bi-geo-alt me-2"></i>Revier & Hochsitz</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Revier</label>
                            <select name="revier_ref" id="revier_ref" class="form-select" onchange="filterHochsitze()">
                                <option value="">-- Revier w√§hlen --</option>
                                {% for r in reviere %}
                                <option value="{{ r.pk }}" {% if eintrag.revier_ref.pk == r.pk %}selected{% endif %}>
                                    {{ r.name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if not reviere %}
                            <div class="form-text">
                                <a href="{% url 'revier_neu' %}">Erst ein Revier anlegen</a>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Hochsitz (optional)</label>
                            <select name="hochsitz_ref" id="hochsitz_ref" class="form-select">
                                <option value="">-- Hochsitz w√§hlen --</option>
                                {% for h in hochsitze %}
                                <option value="{{ h.pk }}" data-revier="{{ h.revier.pk }}" {% if eintrag.hochsitz_ref.pk == h.pk %}selected{% endif %}>
                                    {{ h.get_typ_emoji }} {{ h.name }} ({{ h.revier.name }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Gewicht & Alter -->
                        <div class="col-md-6">
                            <h5 class="section-title"><i class="bi bi-speedometer me-2"></i>Details</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-6">
                                    <label class="form-label">Gewicht (kg)</label>
                                    <input type="number" name="gewicht" class="form-control" step="0.1" min="0"
                                           placeholder="z.B. 15.5"
                                           value="{{ eintrag.gewicht|unlocalize|default:'' }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Gesch√§tztes Alter</label>
                                    <input type="text" name="alter_geschaetzt" class="form-control"
                                           placeholder="z.B. 2-j√§hrig"
                                           value="{{ eintrag.alter_geschaetzt|default:'' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Jagdart & Waffe -->
                        <div class="col-md-6">
                            <h5 class="section-title"><i class="bi bi-bullseye me-2"></i>Jagd</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-6">
                                    <label class="form-label">Jagdart</label>
                                    <select name="jagdart" class="form-select">
                                        <option value="">-- w√§hlen --</option>
                                        <option value="Ansitz" {% if eintrag and eintrag.jagdart == 'Ansitz' %}selected{% endif %}>ü™ë Ansitz</option>
                                        <option value="Pirsch" {% if eintrag and eintrag.jagdart == 'Pirsch' %}selected{% endif %}>üö∂ Pirsch</option>
                                        <option value="Dr√ºckjagd" {% if eintrag and eintrag.jagdart == 'Dr√ºckjagd' %}selected{% endif %}>üèÉ Dr√ºckjagd</option>
                                        <option value="Treibjagd" {% if eintrag and eintrag.jagdart == 'Treibjagd' %}selected{% endif %}>üë• Treibjagd</option>
                                        <option value="Lockjagd" {% if eintrag and eintrag.jagdart == 'Lockjagd' %}selected{% endif %}>üì£ Lockjagd</option>
                                        <option value="Fallenjagd" {% if eintrag and eintrag.jagdart == 'Fallenjagd' %}selected{% endif %}>ü™§ Fallenjagd</option>
                                        <option value="Sonstiges" {% if eintrag and eintrag.jagdart == 'Sonstiges' %}selected{% endif %}>‚ùì Sonstiges</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Entfernung (m)</label>
                                    <input type="number" name="entfernung" class="form-control" min="0"
                                           placeholder="z.B. 80"
                                           value="{{ eintrag.entfernung|unlocalize|default:'' }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Waffe -->
                    <div class="mb-4">
                        <label class="form-label">Waffe</label>
                        <select name="waffe_ref" class="form-select">
                            <option value="">-- Waffe w√§hlen --</option>
                            {% for w in waffen %}
                            <option value="{{ w.pk }}" {% if eintrag.waffe_ref.pk == w.pk %}selected{% elif not eintrag and letzter_eintrag and letzter_eintrag.waffe_ref.pk == w.pk %}selected{% endif %}>
                                {{ w.name }}{% if w.kaliber %} ({{ w.kaliber }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        {% if not waffen %}
                        <div class="form-text">
                            <a href="{% url 'waffe_neu' %}">Erst eine Waffe anlegen</a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Wetter -->
                    <h5 class="section-title"><i class="bi bi-cloud-sun me-2"></i>Wetterbedingungen</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <select name="wetter" class="form-select">
                                <option value="">-- Wetter w√§hlen --</option>
                                <option value="Sonnig" {% if eintrag and eintrag.wetter == 'Sonnig' %}selected{% endif %}>‚òÄÔ∏è Sonnig</option>
                                <option value="Leicht bew√∂lkt" {% if eintrag and eintrag.wetter == 'Leicht bew√∂lkt' %}selected{% endif %}>üå§Ô∏è Leicht bew√∂lkt</option>
                                <option value="Bew√∂lkt" {% if eintrag and eintrag.wetter == 'Bew√∂lkt' %}selected{% endif %}>‚òÅÔ∏è Bew√∂lkt</option>
                                <option value="Bedeckt" {% if eintrag and eintrag.wetter == 'Bedeckt' %}selected{% endif %}>üå•Ô∏è Bedeckt</option>
                                <option value="Leichter Regen" {% if eintrag and eintrag.wetter == 'Leichter Regen' %}selected{% endif %}>üå¶Ô∏è Leichter Regen</option>
                                <option value="Regen" {% if eintrag and eintrag.wetter == 'Regen' %}selected{% endif %}>üåßÔ∏è Regen</option>
                                <option value="Nebel" {% if eintrag and eintrag.wetter == 'Nebel' %}selected{% endif %}>üå´Ô∏è Nebel</option>
                                <option value="Schnee" {% if eintrag and eintrag.wetter == 'Schnee' %}selected{% endif %}>üå®Ô∏è Schnee</option>
                                <option value="Wind" {% if eintrag and eintrag.wetter == 'Wind' %}selected{% endif %}>üí® Windig</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <input type="number" name="temperatur" class="form-control" 
                                       placeholder="Temp." min="-30" max="45"
                                       value="{{ eintrag.temperatur|unlocalize|default:'' }}">
                                <span class="input-group-text">¬∞C</span>
                            </div>
                        </div>
                    </div>

                    <!-- Notizen -->
                    <h5 class="section-title"><i class="bi bi-journal-text me-2"></i>Notizen</h5>
                    <div class="mb-4">
                        <textarea name="notizen" class="form-control" rows="4"
                                  placeholder="Besondere Beobachtungen, Umst√§nde, Markierungen...">{{ eintrag.notizen|default:'' }}</textarea>
                    </div>

                    <!-- Troph√§e -->
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="trophaee" id="trophaee"
                                   {% if eintrag.trophaee %}checked{% endif %}>
                            <label class="form-check-label" for="trophaee">
                                <i class="bi bi-trophy me-1 text-warning"></i>Troph√§e aufgehoben
                            </label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between pt-3 border-top">
                        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-arrow-left me-1"></i>Abbrechen
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-lg me-1"></i>
                            {% if eintrag %}Speichern{% else %}Eintrag erstellen{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function toggleCustomWildart(radio) {
    const div = document.getElementById('customWildartDiv');
    div.style.display = radio.checked ? 'block' : 'none';
}

// Hochsitze nach gew√§hltem Revier filtern
function filterHochsitze() {
    const revierSelect = document.getElementById('revier_ref');
    const hochsitzSelect = document.getElementById('hochsitz_ref');
    const selectedRevier = revierSelect.value;
    const currentHochsitz = hochsitzSelect.value;
    
    Array.from(hochsitzSelect.options).forEach(option => {
        if (option.value === '') {
            // Placeholder immer zeigen
            option.style.display = '';
        } else {
            const optionRevier = option.getAttribute('data-revier');
            if (!selectedRevier || optionRevier === selectedRevier) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
                // Wenn der aktuell gew√§hlte Hochsitz versteckt wird, zur√ºcksetzen
                if (option.value === currentHochsitz) {
                    hochsitzSelect.value = '';
                }
            }
        }
    });
}

// Pr√ºfen bei Seitenlade ob Sonstiges ausgew√§hlt
document.addEventListener('DOMContentLoaded', function() {
    const sonstigesRadio = document.getElementById('wildart_sonstiges');
    if (sonstigesRadio && sonstigesRadio.checked) {
        document.getElementById('customWildartDiv').style.display = 'block';
    }
    
    // Bei anderen Wildarten das Custom-Feld ausblenden
    document.querySelectorAll('input[name="wildart"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const div = document.getElementById('customWildartDiv');
            div.style.display = this.value === 'sonstiges' ? 'block' : 'none';
        });
    });
    
    // Initial Hochsitze filtern
    filterHochsitze();
});
</script>
{% endblock %}
